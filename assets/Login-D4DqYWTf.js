import{j as e}from"./ui-CIANOcUa.js";import{a as m,i as F}from"./vendor-Di3rkBj0.js";import{V as T,x as D,y as L,z as P,A,J as k,W as u,Y as h,O as y,L as N,K as q,N as R,Z as W,w as t}from"./index-C4XDO3q4.js";import{T as I,a as z,b,c as E}from"./tabs-CjbAmd7P.js";function K(){const[o,l]=m.useState(!1),[f,c]=m.useState(null),x=F(),{toast:g}=T();m.useEffect(()=>{(async()=>{const{data:{session:s}}=await t.auth.getSession();if(!(s!=null&&s.user))return;const{data:r}=await t.from("profiles").select("role").eq("id",s.user.id).single();(r==null?void 0:r.role)==="admin"&&x("/admin/dashboard")})()},[]);const v=async i=>{i.preventDefault(),l(!0),c(null);const s=new FormData(i.currentTarget),r=s.get("email"),a=s.get("password");try{const{data:n,error:p}=await t.auth.signInWithPassword({email:r,password:a});if(p)throw p;const{data:d,error:w}=await t.from("profiles").select("role").eq("id",n.user.id).single();if(w){console.error("Profile fetch error:",w);const{count:C}=await t.from("profiles").select("*",{count:"exact",head:!0});if(C===0){const{error:j}=await t.from("profiles").insert({id:n.user.id,email:n.user.email,role:"admin"});if(j)throw console.error("Error creating admin profile:",j),new Error("Failed to create admin profile");console.log("Created first admin user")}else throw new Error("Profile not found. Please contact administrator.")}else if((d==null?void 0:d.role)!=="admin")throw new Error("Unauthorized. Admin access required.");g({title:"Welcome back!",description:"Successfully logged in to admin dashboard"}),x("/admin/dashboard")}catch(n){c(n instanceof Error?n.message:"Failed to log in")}finally{l(!1)}},S=async i=>{i.preventDefault(),l(!0),c(null);const r=new FormData(i.currentTarget).get("email");try{const{error:a}=await t.auth.resetPasswordForEmail(r,{redirectTo:window.location.origin+"/admin/reset-password"});if(a)throw a;g({title:"Check your email",description:"We've sent you a password reset link"})}catch(a){c(a instanceof Error?a.message:"Failed to send reset email")}finally{l(!1)}};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 px-4",children:e.jsxs(D,{className:"w-full max-w-md",children:[e.jsxs(L,{className:"space-y-1",children:[e.jsx(P,{className:"text-2xl font-bold text-center",children:"Admin Portal"}),e.jsx(A,{className:"text-center",children:"Manage your church's digital presence"})]}),e.jsxs(k,{children:[e.jsxs(I,{defaultValue:"login",className:"space-y-4",children:[e.jsxs(z,{className:"grid w-full grid-cols-2",children:[e.jsx(b,{value:"login",children:"Login"}),e.jsx(b,{value:"reset",children:"Reset"})]}),e.jsx(E,{value:"login",children:e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"login-email",children:"Email"}),e.jsx(h,{id:"login-email",name:"email",type:"email",placeholder:"admin@church.com",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"login-password",children:"Password"}),e.jsx(h,{id:"login-password",name:"password",type:"password",required:!0})]}),e.jsx(y,{type:"submit",className:"w-full",disabled:o,children:o?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Signing in..."]}):"Sign in"})]})}),e.jsx(E,{value:"reset",children:e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"reset-email",children:"Email"}),e.jsx(h,{id:"reset-email",name:"email",type:"email",placeholder:"admin@church.com",required:!0})]}),e.jsx(y,{type:"submit",className:"w-full",disabled:o,children:o?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-4 w-4 animate-spin"}),"Sending reset link..."]}):"Send Reset Link"})]})})]}),f&&e.jsx(q,{variant:"destructive",className:"mt-4",children:e.jsx(R,{children:f})})]}),e.jsx(W,{className:"flex flex-col space-y-2",children:e.jsx("p",{className:"px-8 text-center text-sm text-gray-600",children:"Secure access to manage church content, members, and settings"})})]})})}export{K as default};
