import{j as e}from"./ui-CIANOcUa.js";import{a as t}from"./vendor-Di3rkBj0.js";import{T as he,a as xe,b as B,c as d,d as ue,e as o}from"./table-CcA4TWxd.js";import{V as je,w as m,L as _,$ as ge,a0 as fe,O as h,a1 as pe,a2 as we,a3 as be,W as k,Y as O,a8 as ve,a9 as Ne,aa as ye,ab as Ce,ac as J,x as j,y as g,z as f,A as P,J as p,t as M}from"./index-C4XDO3q4.js";import{A as w,a as L,b,c as v,d as N,e as y,f as C,g as A,h as U}from"./alert-dialog-Co1IkATV.js";import{U as X}from"./user-plus-BYIiAgPk.js";import{E as Ae,C as Y,S as Ue,A as $,a as G,U as K}from"./user-x-BofiWNV2.js";import{E as De}from"./eye-L4evpcbO.js";import{S as Se}from"./search-BOIwQ3kk.js";import{T as Ee}from"./trash-2-DlTU7m4C.js";function Ve(){const[D,Q]=t.useState([]),[z,q]=t.useState([]),[S,E]=t.useState(!0),[Z,H]=t.useState(!1),[ee,T]=t.useState(!1),[a,R]=t.useState(null),[l,se]=t.useState(0),[I,re]=t.useState(0),[x,te]=t.useState(""),{toast:i}=je(),[Te,Fe]=t.useState(null),[ae,le]=t.useState(!1);t.useEffect(()=>{c()},[]),t.useEffect(()=>{ie()},[D,x]);const c=async()=>{try{const{data:s,error:r}=await m.from("profiles").select("*").order("created_at",{ascending:!1});if(r)throw r;Q(s);const u=s.filter(F=>F.role==="admin");se(u.length),re(s.length-u.length)}catch(s){console.error("Error fetching users:",s),i({title:"Error",description:"Failed to fetch users",variant:"destructive"})}finally{E(!1)}},ie=()=>{if(!x){q(D);return}const s=D.filter(r=>r.email.toLowerCase().includes(x.toLowerCase()));q(s)},ne=async s=>{s.preventDefault(),E(!0);const r=new FormData(s.currentTarget),u=r.get("email"),F=r.get("password"),me=r.get("role");try{const{data:n,error:V}=await m.functions.invoke("create-user",{body:{email:u,password:F,role:me}});if(V||n!=null&&n.error)throw new Error((n==null?void 0:n.error)||V.message);i({title:"Success",description:"User created successfully"}),H(!1),c()}catch(n){i({title:"Error",description:n instanceof Error?n.message:"Failed to create user",variant:"destructive"})}finally{E(!1)}},ce=async s=>{try{const{error:r}=await m.from("profiles").update({role:"admin"}).eq("id",s);if(r)throw r;i({title:"Success",description:"User promoted to admin successfully"}),await c()}catch(r){console.error("Error promoting user:",r),i({title:"Error",description:"Failed to promote user to admin",variant:"destructive"})}},de=async s=>{try{if(l<=1){i({title:"Cannot Demote",description:"Cannot demote the last admin user",variant:"destructive"});return}const{error:r}=await m.from("profiles").update({role:"user"}).eq("id",s);if(r)throw r;i({title:"Success",description:"Admin demoted to user successfully"}),await c()}catch(r){console.error("Error demoting admin:",r),i({title:"Error",description:"Failed to demote admin",variant:"destructive"})}},oe=s=>{R(s),T(!0)},W=async()=>{if(a)try{if(a.role==="admin"&&l<=1){i({title:"Cannot Delete",description:"Cannot delete the last admin user",variant:"destructive"});return}const{error:s}=await m.from("profiles").delete().eq("id",a.id);if(s)throw s;i({title:"Success",description:"User deleted successfully"}),await c()}catch(s){console.error("Error deleting user:",s),i({title:"Error",description:"Failed to delete user",variant:"destructive"})}finally{T(!1),R(null)}};return S?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(_,{className:"h-8 w-8 animate-spin text-church-burgundy"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-church-burgundy",children:"User Management"}),e.jsx("p",{className:"text-gray-600",children:"Add, edit, or remove users and manage their roles"})]}),e.jsxs(ge,{open:Z,onOpenChange:H,children:[e.jsx(fe,{asChild:!0,children:e.jsxs(h,{className:"bg-church-burgundy hover:bg-church-burgundy/90",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Add User"]})}),e.jsxs(pe,{children:[e.jsx(we,{children:e.jsx(be,{children:"Add New User"})}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(k,{htmlFor:"email",children:"Email"}),e.jsx(O,{id:"email",name:"email",type:"email",placeholder:"user@example.com",required:!0})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"password",children:"Password"}),e.jsx("div",{className:"relative",children:e.jsx(O,{id:"password",name:"password",type:"password",placeholder:"Set user password",required:!0})}),e.jsx("button",{type:"button",className:"absolute inset-y-0 right-2 flex items-center text-gray-500",onClick:()=>le(s=>!s),children:ae?e.jsx(Ae,{size:18}):e.jsx(De,{size:18})})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"role",children:"Role"}),e.jsxs(ve,{name:"role",defaultValue:"user",children:[e.jsx(Ne,{children:e.jsx(ye,{})}),e.jsxs(Ce,{children:[e.jsx(J,{value:"user",children:"User"}),e.jsx(J,{value:"admin",children:"Admin"})]})]})]}),e.jsxs(h,{type:"submit",className:"w-full bg-church-burgundy hover:bg-church-burgundy/90",children:[S?e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(X,{className:"h-4 w-4 mr-2"}),S?"Adding User...":"Add User"]})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(j,{children:[e.jsxs(g,{className:"pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Admin Users"}),e.jsx(P,{children:"Users with administrative privileges"})]}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Y,{className:"h-5 w-5 text-yellow-600 mr-2"}),e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:l})]})})]}),e.jsxs(j,{children:[e.jsxs(g,{className:"pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Regular Users"}),e.jsx(P,{children:"Users with standard access"})]}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:"h-5 w-5 text-blue-600 mr-2"}),e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:I})]})})]}),e.jsxs(j,{children:[e.jsxs(g,{className:"pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"Total Users"}),e.jsx(P,{children:"All registered users"})]}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ue,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:l+I})]})})]})]}),e.jsxs(j,{children:[e.jsx(g,{children:e.jsx(f,{className:"text-lg",children:"Search Users"})}),e.jsx(p,{children:e.jsxs("div",{className:"relative",children:[e.jsx(Se,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(O,{placeholder:"Search by email...",value:x,onChange:s=>te(s.target.value),className:"pl-10"})]})})]}),e.jsxs("div",{className:"border rounded-lg",children:[e.jsxs(he,{children:[e.jsx(xe,{children:e.jsxs(B,{children:[e.jsx(d,{children:"Email"}),e.jsx(d,{children:"Role"}),e.jsx(d,{children:"Admin Actions"}),e.jsx(d,{children:"Created At"}),e.jsx(d,{className:"w-[120px]",children:"Actions"})]})}),e.jsx(ue,{children:z.map(s=>e.jsxs(B,{children:[e.jsx(o,{children:s.email}),e.jsx(o,{children:e.jsx("div",{className:"flex items-center space-x-2",children:s.role==="admin"?e.jsxs("div",{className:"flex items-center space-x-1 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium",children:[e.jsx(Y,{className:"h-3 w-3"}),e.jsx("span",{children:"Admin"})]}):e.jsxs("div",{className:"flex items-center space-x-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium",children:[e.jsx(M,{className:"h-3 w-3"}),e.jsx("span",{children:"User"})]})})}),e.jsx(o,{children:e.jsx("div",{className:"flex items-center space-x-2",children:s.role==="admin"?e.jsxs(w,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(h,{variant:"outline",size:"sm",className:"text-orange-600 hover:text-orange-700 border-orange-200 hover:border-orange-300",disabled:l<=1,children:[e.jsx($,{className:"h-3 w-3 mr-1"}),"Demote"]})}),e.jsxs(b,{children:[e.jsxs(v,{children:[e.jsx(N,{children:"Demote Admin"}),e.jsxs(y,{children:["Are you sure you want to demote ",s.email," from admin to regular user?",l<=1&&e.jsx("p",{className:"text-red-500 mt-2 font-bold",children:"Warning: Cannot demote the last admin user."})]})]}),e.jsxs(C,{children:[e.jsx(A,{children:"Cancel"}),e.jsxs(U,{onClick:()=>de(s.id),className:"bg-orange-600 hover:bg-orange-700",disabled:l<=1,children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Demote to User"]})]})]})]}):e.jsxs(w,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(h,{variant:"outline",size:"sm",className:"text-green-600 hover:text-green-700 border-green-200 hover:border-green-300",children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),"Promote"]})}),e.jsxs(b,{children:[e.jsxs(v,{children:[e.jsx(N,{children:"Promote to Admin"}),e.jsxs(y,{children:["Are you sure you want to promote ",s.email," to admin? This will give them full administrative privileges."]})]}),e.jsxs(C,{children:[e.jsx(A,{children:"Cancel"}),e.jsxs(U,{onClick:()=>ce(s.id),className:"bg-green-600 hover:bg-green-700",children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"Promote to Admin"]})]})]})]})})}),e.jsx(o,{children:new Date(s.created_at).toLocaleDateString()}),e.jsx(o,{children:e.jsx("div",{className:"flex space-x-2",children:e.jsxs(w,{children:[e.jsx(L,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"text-red-500 hover:text-red-700",onClick:()=>oe(s),children:e.jsx(Ee,{className:"h-4 w-4"})})}),e.jsxs(b,{children:[e.jsxs(v,{children:[e.jsx(N,{children:"Delete User"}),e.jsxs(y,{children:["Are you sure you want to delete ",s.email,"? This action cannot be undone.",s.role==="admin"&&l<=1&&e.jsx("p",{className:"text-red-500 mt-2 font-bold",children:"Warning: Cannot delete the last admin user."})]})]}),e.jsxs(C,{children:[e.jsx(A,{children:"Cancel"}),e.jsxs(U,{onClick:W,className:"bg-red-600 hover:bg-red-700",disabled:s.role==="admin"&&l<=1,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Delete User"]})]})]})]})})})]},s.id))})]}),z.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No users found matching your criteria."})]}),e.jsx(w,{open:ee,onOpenChange:T,children:e.jsxs(b,{children:[e.jsxs(v,{children:[e.jsx(N,{children:"Delete User"}),e.jsxs(y,{children:["Are you sure you want to delete ",a==null?void 0:a.email,"? This action cannot be undone.",(a==null?void 0:a.role)==="admin"&&l<=1&&e.jsx("p",{className:"text-red-500 mt-2 font-bold",children:"Warning: Cannot delete the last admin user."})]})]}),e.jsxs(C,{children:[e.jsx(A,{children:"Cancel"}),e.jsxs(U,{onClick:W,className:"bg-red-600 hover:bg-red-700",disabled:(a==null?void 0:a.role)==="admin"&&l<=1,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Delete User"]})]})]})})]})}export{Ve as default};
