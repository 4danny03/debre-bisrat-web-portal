import{j as e}from"./ui-BKKtghGE.js";import{a as i}from"./vendor-DsXQwQzb.js";import{x as J,Q as ce,J as Q,O as o,V as oe,_ as E,w as I,a8 as A,a9 as R,R as P,aa as D,ab as k,ac as l,Y as F,ad as me,b as he,y as xe,z as ue,A as pe,ao as H,U as je,M as ve,P as ge,a5 as q,C as U,m as z,$ as fe,a1 as ye,a2 as be,a3 as Ce,ae as Ne,W as f,a4 as O,ap as we,l as W}from"./index-BzL-sfoN.js";import{B as Se}from"./badge-ClsmbL3M.js";import{T as _e,a as Ae,b as Y,c as p,d as Re,e as j}from"./table-DO2FNJGZ.js";import{F as De}from"./FileSaver.min-D6DqY2Qh.js";import{M as ke}from"./message-square-Dz3KcmE4.js";import{C as qe}from"./circle-x-Dib2-vLt.js";const Me=({icon:h,title:b,description:C,action:x,className:r,ariaLabel:N})=>e.jsx(J,{className:ce("border-dashed",r),role:"region","aria-label":N||b,children:e.jsxs(Q,{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4","aria-hidden":"true",children:e.jsx(h,{className:"w-8 h-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",id:"empty-state-title",children:b}),C&&e.jsx("p",{className:"text-gray-500 mb-6 max-w-sm","aria-live":"polite",children:C}),x&&e.jsx(o,{onClick:x.onClick,className:"bg-church-burgundy hover:bg-church-burgundy/90","aria-label":x.label,children:x.label})]})}),Pe=()=>{const[h,b]=i.useState([]),[C,x]=i.useState(!0),[r,N]=i.useState(null),[X,w]=i.useState(!1),[G,M]=i.useState(""),[v,K]=i.useState(""),[d,L]=i.useState("all"),[S,Z]=i.useState(null),{toast:g}=oe(),[V,$]=i.useState(null),[m,T]=i.useState(new Set),y=i.useCallback(async()=>{x(!0),$(null);try{let s;!d||d==="all"?s=await E.appointments.getAppointments():s=await E.appointments.getAppointmentsByStatus(d),b(s||[])}catch(s){const t=typeof s=="object"&&s!==null&&"message"in s?s.message:String(s);$(t||"Failed to load appointments"),g({title:"Error",description:t||"Failed to load appointments",variant:"destructive"})}finally{x(!1)}},[d,g]);i.useEffect(()=>{y(),ee()},[y]);const ee=async()=>{const{data:{session:s}}=await I.auth.getSession();Z((s==null?void 0:s.user)??null)},se=async s=>{if(s.preventDefault(),!r||!S)return;const t=new FormData(s.currentTarget),a=t.get("status"),c=t.get("admin_response"),n=t.get("admin_notes"),B=t.get("confirmed_date"),ie=t.get("confirmed_time");try{await E.appointments.respondToAppointment(r.id,{status:a,admin_response:c,admin_notes:n||void 0,confirmed_date:B||void 0,confirmed_time:ie||void 0,responded_by:S==null?void 0:S.id}),g({title:"Success",description:"Response sent successfully"}),w(!1),N(null),y()}catch(de){console.error("Error responding to appointment:",de),g({title:"Error",description:"Failed to send response",variant:"destructive"})}},te=s=>{const t={pending:{variant:"secondary",icon:z,color:"text-yellow-600"},approved:{variant:"default",icon:W,color:"text-green-600"},rejected:{variant:"destructive",icon:qe,color:"text-red-600"},completed:{variant:"outline",icon:W,color:"text-blue-600"}},a=t[s]||t.pending,c=a.icon;return e.jsxs(Se,{variant:a.variant,className:"capitalize",children:[e.jsx(c,{className:`w-3 h-3 mr-1 ${a.color}`}),s]})},ae=s=>{N(s),M(s.admin_response||""),w(!0)},u=i.useMemo(()=>{let s=h;return d&&d!=="all"&&(s=s.filter(t=>t.status===d)),v&&(s=s.filter(t=>{var a,c,n;return((a=t.name)==null?void 0:a.toLowerCase().includes(v.toLowerCase()))||((c=t.email)==null?void 0:c.toLowerCase().includes(v.toLowerCase()))||((n=t.service_title)==null?void 0:n.toLowerCase().includes(v.toLowerCase()))})),s},[h,d,v]),ne=()=>{const s=m.size>0?u.filter(n=>m.has(n.id)):u,a=[["ID","Name","Email","Phone","Service","Date","Time","Status","Admin Notes"],...s.map(n=>[n.id,n.name,n.email,n.phone,n.service_title,n.requested_date,n.requested_time,n.status,n.admin_notes||""])].map(n=>n.join(",")).join(`
`),c=new Blob([a],{type:"text/csv"});De.saveAs(c,"appointments.csv")},re=s=>{const t=new Set(m);s?u.forEach(a=>t.add(a.id)):u.forEach(a=>t.delete(a.id)),T(t)},le=(s,t)=>{const a=new Set(m);t?a.add(s):a.delete(s),T(a)},_=async s=>{const t=Array.from(m);if(t.length!==0)try{const{error:a}=await I.from("appointments").update({status:s,updated_at:new Date().toISOString()}).in("id",t);if(a)throw a;g({title:"Updated",description:`Updated ${t.length} appointment(s)`}),T(new Set),y()}catch(a){console.error("Bulk status update failed",a),g({title:"Error",description:"Failed to update selected appointments",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6",children:[V&&e.jsxs("div",{className:"bg-red-100 text-red-700 p-4 rounded mb-4",children:[e.jsx("b",{children:"Error:"})," ",V]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-church-burgundy",children:"Appointments"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage appointment requests from the services page"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(A,{value:d,onValueChange:L,children:[e.jsxs(R,{className:"w-full sm:w-40",children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),e.jsx(D,{})]}),e.jsxs(k,{children:[e.jsx(l,{value:"all",children:"All Status"}),e.jsx(l,{value:"pending",children:"Pending"}),e.jsx(l,{value:"approved",children:"Approved"}),e.jsx(l,{value:"rejected",children:"Rejected"}),e.jsx(l,{value:"completed",children:"Completed"})]})]}),e.jsxs(o,{onClick:y,variant:"outline",children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Refresh"]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx(F,{placeholder:"Search by name, email, or service...",value:v,onChange:s=>K(s.target.value)}),e.jsxs(A,{value:d,onValueChange:L,children:[e.jsx(R,{children:e.jsx(D,{placeholder:"Status"})}),e.jsxs(k,{children:[e.jsx(l,{value:"all",children:"All"}),e.jsx(l,{value:"pending",children:"Pending"}),e.jsx(l,{value:"approved",children:"Approved"}),e.jsx(l,{value:"rejected",children:"Rejected"}),e.jsx(l,{value:"completed",children:"Completed"})]})]}),e.jsx(o,{onClick:ne,children:"Export CSV"})]}),C?e.jsx(me,{className:"h-64",text:"Loading appointments...",ariaLabel:"Loading appointments"}):h.length===0?e.jsx(Me,{icon:he,title:"No appointments found",description:"No appointment requests match the current filter."}):e.jsxs(J,{children:[e.jsxs(xe,{children:[e.jsx(ue,{children:"Appointment Requests"}),e.jsxs(pe,{children:[h.length," appointment",h.length!==1?"s":""," found"]})]}),e.jsxs(Q,{children:[m.size>0&&e.jsxs("div",{className:"flex items-center justify-between mb-4 p-2 rounded border bg-muted/30",children:[e.jsxs("div",{className:"text-sm",children:[m.size," selected"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",onClick:()=>_("pending"),children:"Mark Pending"}),e.jsx(o,{variant:"outline",onClick:()=>_("approved"),children:"Approve"}),e.jsx(o,{variant:"outline",onClick:()=>_("rejected"),children:"Reject"}),e.jsx(o,{variant:"outline",onClick:()=>_("completed"),children:"Complete"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(_e,{children:[e.jsx(Ae,{children:e.jsxs(Y,{children:[e.jsx(p,{className:"w-10",children:e.jsx(H,{"aria-label":"Select all visible",checked:u.length>0&&u.every(s=>m.has(s.id)),onCheckedChange:s=>re(!!s)})}),e.jsx(p,{children:"Requester"}),e.jsx(p,{children:"Service"}),e.jsx(p,{children:"Requested Date/Time"}),e.jsx(p,{children:"Status"}),e.jsx(p,{children:"Submitted"}),e.jsx(p,{children:"Actions"})]})}),e.jsx(Re,{children:u.map(s=>e.jsxs(Y,{children:[e.jsx(j,{children:e.jsx(H,{"aria-label":`Select appointment ${s.id}`,checked:m.has(s.id),onCheckedChange:t=>le(s.id,!!t)})}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"font-medium flex items-center",children:[e.jsx(je,{className:"w-4 h-4 mr-1"}),s.name]}),e.jsxs("div",{className:"text-sm text-gray-500 flex items-center",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),s.email]}),e.jsxs("div",{className:"text-sm text-gray-500 flex items-center",children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),s.phone]})]})}),e.jsxs(j,{children:[e.jsx("div",{className:"font-medium",children:s.service_title}),s.notes&&e.jsxs("div",{className:"text-sm text-gray-500 mt-1 flex items-start",children:[e.jsx(ke,{className:"w-3 h-3 mr-1 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"line-clamp-2",children:s.notes})]})]}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(U,{className:"w-3 h-3 mr-1"}),q(new Date(s.requested_date),"MMM d, yyyy")]}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[e.jsx(z,{className:"w-3 h-3 mr-1"}),s.requested_time]}),s.confirmed_date&&s.confirmed_date!==s.requested_date&&e.jsxs("div",{className:"flex items-center text-sm text-green-600",children:[e.jsx(U,{className:"w-3 h-3 mr-1"}),"Confirmed:"," ",q(new Date(s.confirmed_date),"MMM d, yyyy")]})]})}),e.jsx(j,{children:te(s.status)}),e.jsxs(j,{children:[e.jsx("div",{className:"text-sm text-gray-500",children:q(new Date(s.created_at),"MMM d, yyyy HH:mm")}),s.responded_at&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Responded:"," ",q(new Date(s.responded_at),"MMM d, HH:mm")]})]}),e.jsx(j,{children:e.jsx(o,{size:"sm",onClick:()=>ae(s),className:"bg-church-burgundy hover:bg-church-burgundy/90",children:s.status==="pending"?"Respond":"Update"})})]},s.id))})]})})]})]}),e.jsx(fe,{open:X,onOpenChange:w,children:e.jsxs(ye,{className:"max-w-2xl",children:[e.jsxs(be,{children:[e.jsx(Ce,{children:"Respond to Appointment Request"}),e.jsx(Ne,{children:r&&e.jsxs("span",{children:["Responding to ",r.name,"'s request for"," ",r.service_title]})})]}),r&&e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"status",children:"Status"}),e.jsxs(A,{name:"status",defaultValue:r.status,children:[e.jsx(R,{children:e.jsx(D,{})}),e.jsxs(k,{children:[e.jsx(l,{value:"pending",children:"Pending"}),e.jsx(l,{value:"approved",children:"Approved"}),e.jsx(l,{value:"rejected",children:"Rejected"}),e.jsx(l,{value:"completed",children:"Completed"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"confirmed_date",children:"Confirmed Date (if approved)"}),e.jsx(F,{id:"confirmed_date",name:"confirmed_date",type:"date",defaultValue:r.confirmed_date||r.requested_date})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Response Templates"}),e.jsxs(A,{onValueChange:s=>{const t=r.name||"",a=r.service_title||"the service",c=r.requested_date||"",n=r.requested_time||"",B={approve:`Dear ${t},

Your appointment request for ${a} on ${c} at ${n} has been approved. We look forward to seeing you.

Blessings,
Church Admin`,reschedule:`Dear ${t},

We received your request for ${a}. Could we reschedule to a different date/time? Please reply with your availability.

Blessings,
Church Admin`,decline:`Dear ${t},

Unfortunately, we are unable to accommodate your appointment request for ${a} at the requested time. Please consider alternative times.

Blessings,
Church Admin`};M(B[s]||"")},children:[e.jsx(R,{children:e.jsx(D,{placeholder:"Insert a template (optional)"})}),e.jsxs(k,{children:[e.jsx(l,{value:"approve",children:"Approval"}),e.jsx(l,{value:"reschedule",children:"Request Reschedule"}),e.jsx(l,{value:"decline",children:"Decline"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"confirmed_time",children:"Confirmed Time (if approved)"}),e.jsx(F,{id:"confirmed_time",name:"confirmed_time",type:"time",defaultValue:r.confirmed_time||r.requested_time})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"admin_response",children:"Response Message *"}),e.jsx(O,{id:"admin_response",name:"admin_response",placeholder:"Enter your response to the appointment request...",value:G,onChange:s=>M(s.target.value),required:!0,rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"admin_notes",children:"Internal Notes (optional)"}),e.jsx(O,{id:"admin_notes",name:"admin_notes",placeholder:"Internal notes for admin reference...",defaultValue:r.admin_notes||"",rows:3})]}),e.jsxs(we,{children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>w(!1),children:"Cancel"}),e.jsx(o,{type:"submit",className:"bg-church-burgundy hover:bg-church-burgundy/90",children:"Send Response"})]})]})]})}),e.jsxs("div",{className:"mt-8",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Activity Log"}),e.jsx("div",{className:"text-sm text-gray-500",children:"(Activity log will appear here)"})]})]})};export{Pe as default};
